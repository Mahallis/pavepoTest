# Тестовый проект PavepoTest

Это проект на FastAPI с аутентификацией через OAuth2 и функциональностью управления файлами.
Включает в себя эндпоинты для работы с аудиофайлами (загрузка, переименование, удаление и т.д.)
и аутентификацию пользователей через Yandex OAuth.

##### При разработки использовались следующие технологии:

- Python >= 3.12
- Postgres 16
- Docker 28

## Содержание

- [Установка](#установка)
- [Использование](#использование)
- [API Эндпоинты](#api-эндпоинты)
- [Зависимости](#зависимости)

## Установка

Для начала клонируйте этот репозиторий и установите все зависимости.

### Клонировать репозиторий

```bash
git clone git@github.com:Mahallis/pavepoTest.git
cd pavepoTest
```

### Зарегистрировать приложение в [Яндекс OAuth](https://oauth.yandex.ru/)

Сделать это можно следуя инструкциям на странице с [документацией](https://yandex.ru/dev/id/doc/ru/register-client).

### Создать файл с переменными окружения .env

В корне проекта создайте файл .env, который необходимо заполнить по образцу .env-example. Требуются следующие переменные:

```bash
POSTGRES_USER
POSTGRES_PASSWORD
POSTGRES_NAME
APP_SECRET_KEY
DB_HOST
DB_PORT
YANDEX_CLIENT_ID
YANDEX_CLIENT_SECRET
```

### Запустить контейнеры с помощью docker compose

```bash
docker compose up -d
```

Если вы хотите видеть в реальном времени логи приложения, то необходимо убрать опцию `-d ` из команды выше

## Использование

Приложение будет доступно по адресу `http://127.0.0.1:8000/`
Для доступа к документации Swagger UI, необходимо перейти по адресу `http://127.0.0.1:8000/docs`

### Получение прав суперпользователя

Для того, чтобы сделать обычного пользователя суперпользователем, необходимо, после его добавления в базу данных выполнить следующие действия:

#### Запустить оболочку контейнера с БД в интерактивном режиме

```bash
docker exec -it audio_db /bin/bash
```

#### Запустить утилиту psql внутри контейнера db_audio

```bash
psql -U <POSTGRES_USER> -d <POSTGRES_NAME>
```

#### Изменить поле <u>role</u> таблицы <u>user</u>

```bash
UPDATE "users" SET role = 'superuser' WHERE id = <id вашего пользователя>;
```

## API Эндпоинты

### Эндпоинты аутентификации

- **GET /auth/login_yandex**: Вход через Yandex.
- **GET /auth/yandex_auth**: Аутентификация через Yandex OAuth, требуется параметр `code` в запросе.
- **POST /auth/refresh_token**: Обновление OAuth токена.

### Эндпоинты для работы с пользователями (требуются права суперпользователя)

- **GET /auth/list_users**: Получение списка всех пользователей.
- **DELETE /auth/delete_user/{user_id}**: Удаление пользователя по его ID.

### Эндпоинты для работы с аудиофайлами

- **GET /audio_storage/**: Получить список всех аудиофайлов.
- **GET /audio_storage/{file_id}**: Получить файл по его ID.
- **POST /audio_storage/upload**: Загрузить новый файл.
- **PATCH /audio_storage/rename/{file_id}**: Переименовать файл.
- **DELETE /audio_storage/delete/{file_id}**: Удалить файл по его ID.

## Зависимости

- FastAPI
- Uvicorn
- SQLAlchemy
- Alembic
- JWT
- httpx
- Docker
